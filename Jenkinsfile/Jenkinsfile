pipeline {
    agent any

    options {
        timestamps()
        disableConcurrentBuilds()
        buildDiscarder(logRotator(numToKeepStr: '20'))
        timeout(time: 45, unit: 'MINUTES')
    }

    environment {
        APP_NAME        = "sample-python-app"
        DOCKER_REGISTRY = "docker.io/yourusername"
        IMAGE_TAG       = "${env.BUILD_NUMBER}"
        KUBE_NAMESPACE  = "ci-demo"
        SONARQUBE_ENV   = "sonarqube-server"
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Build & Unit Tests') {
            parallel {
                stage('Build') {
                    steps {
                        sh '''
                          python -m venv venv
                          . venv/bin/activate
                          pip install -r requirements.txt
                        '''
                    }
                }

                stage('Unit Tests') {
                    steps {
                        sh '''
                          . venv/bin/activate
                          pytest tests/ --junitxml=results.xml
                        '''
                    }
                }
            }
            post {
                always {
                    junit 'results.xml'
                }
            }
        }

        stage('Static Code Analysis') {
            steps {
                withSonarQubeEnv("${SONARQUBE_ENV}") {
                    sh '''
                      sonar-scanner \
                      -Dsonar.projectKey=${APP_NAME} \
                      -Dsonar.sources=app \
                      -Dsonar.python.coverage.reportPaths=coverage.xml
                    '''
                }
            }
        }

        stage('Quality Gate') {
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }

        stage('Docker Build & Push') {
            steps {
                sh '''
                  docker build -t ${DOCKER_REGISTRY}/${APP_NAME}:${IMAGE_TAG} .
                  docker push ${DOCKER_REGISTRY}/${APP_NAME}:${IMAGE_TAG}
                '''
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                sh '''
                  sed -i "s|IMAGE_TAG|${IMAGE_TAG}|g" k8s/deployment.yaml
                  kubectl apply -n ${KUBE_NAMESPACE} -f k8s/
                '''
            }
        }
    }

    post {
        success {
            echo "Pipeline succeeded. Image ${IMAGE_TAG} deployed."
        }

        failure {
            echo "Pipeline failed. Investigate stage-level logs."
        }

        always {
            cleanWs()
        }
    }
}

